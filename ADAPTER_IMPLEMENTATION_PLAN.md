# Adapter Selection Implementation Plan

## üìã Genel Bakƒ±≈ü

Asena CLI'ya **Hono** ve **Ergenecore** adapter se√ßimi √∂zelliƒüi eklenmesi i√ßin detaylƒ± implementasyon planƒ±.

**Se√ßilen Yakla≈üƒ±m:** Minimal JSON Config (Yakla≈üƒ±m A)

---

## üéØ Hedefler

1. `asena init` komutu adapter tercihi soracak
2. `asena create` komutu adapter tercihi soracak
3. Se√ßim `.asena/config.json` dosyasƒ±na kaydedilecek
4. T√ºm kod √ºretimi (generate) bu se√ßime g√∂re yapƒ±lacak
5. Default adapter: **Hono**

---

## üìÅ Dosya Yapƒ±sƒ±

```
.asena/
  ‚îî‚îÄ‚îÄ config.json          # Yeni: Adapter se√ßimi ve CLI tercihleri
asena-config.ts            # Mevcut: Build configuration
```

**`.asena/config.json` √ñrneƒüi:**
```json
{
  "adapter": "hono"
}
```

---

## üîß Implementasyon Adƒ±mlarƒ±

### 1. Type Definitions Olu≈üturma

**Dosya:** `lib/types/adapterConfig.ts` (YENƒ∞)

```typescript
/**
 * Supported adapter types for Asena projects
 */
export type AdapterType = 'hono' | 'ergenecore';

/**
 * CLI configuration stored in .asena/config.json
 */
export interface AdapterConfig {
  adapter: AdapterType;
}
```

**Ama√ß:** Type-safe adapter configuration y√∂netimi

---

### 2. Config Helper Fonksiyonlarƒ±

**Dosya:** `lib/helpers/adapterConfigHelper.ts` (YENƒ∞)

ƒ∞√ßerik:
- `readAdapterConfig(): Promise<AdapterConfig>` - Config dosyasƒ±nƒ± okur
- `writeAdapterConfig(config: AdapterConfig): Promise<void>` - Config dosyasƒ±nƒ± yazar
- `getAdapterConfig(): Promise<AdapterType>` - Sadece adapter tipini d√∂ner
- `isAdapterConfigExists(): boolean` - Config dosyasƒ± var mƒ± kontrol eder
- `ensureConfigDirectory(): void` - `.asena/` klas√∂r√ºn√º olu≈üturur

**Kullanƒ±lacak Bun API'leri:**
- `Bun.file('.asena/config.json').json()` - JSON okuma
- `Bun.write('.asena/config.json', JSON.stringify(...))` - JSON yazma
- `fs.mkdirSync()` - Klas√∂r olu≈üturma

**√ñrnek ƒ∞mplementasyon:**
```typescript
import fs from 'fs';
import path from 'path';
import type { AdapterConfig, AdapterType } from '../types/adapterConfig';

const CONFIG_DIR = '.asena';
const CONFIG_FILE = path.join(CONFIG_DIR, 'config.json');

export async function readAdapterConfig(): Promise<AdapterConfig> {
  if (!isAdapterConfigExists()) {
    return { adapter: 'hono' }; // Default
  }

  const configFile = Bun.file(CONFIG_FILE);
  return await configFile.json();
}

export async function writeAdapterConfig(config: AdapterConfig): Promise<void> {
  ensureConfigDirectory();
  await Bun.write(CONFIG_FILE, JSON.stringify(config, null, 2));
}

export async function getAdapterConfig(): Promise<AdapterType> {
  const config = await readAdapterConfig();
  return config.adapter;
}

export function isAdapterConfigExists(): boolean {
  return fs.existsSync(CONFIG_FILE);
}

export function ensureConfigDirectory(): void {
  if (!fs.existsSync(CONFIG_DIR)) {
    fs.mkdirSync(CONFIG_DIR, { recursive: true });
  }
}
```

---

### 3. Adapter Import Constants

**Dosya:** `lib/constants/adapters.ts` (YENƒ∞)

Her adapter i√ßin import definitionlarƒ±:

```typescript
import type { ImportsByFiles } from '../types';

/**
 * Hono Adapter imports
 */
export const HONO_ROOT_IMPORTS: ImportsByFiles = {
  '@asenajs/asena': ['AsenaServerFactory'],
  '@asenajs/hono-adapter': ['createHonoAdapter'],
};

export const HONO_CONTROLLER_IMPORTS: ImportsByFiles = {
  '@asenajs/asena/server': ['Controller'],
  '@asenajs/asena/web': ['Get'],
  '@asenajs/hono-adapter': ['type Context'],
};

export const HONO_MIDDLEWARE_IMPORTS: ImportsByFiles = {
  '@asenajs/asena/server': ['Middleware'],
  '@asenajs/hono-adapter': ['type Context', 'MiddlewareService'],
};

/**
 * Ergenecore Adapter imports
 */
export const ERGENECORE_ROOT_IMPORTS: ImportsByFiles = {
  '@asenajs/asena': ['AsenaServerFactory'],
  '@asenajs/ergenecore': ['createErgenecoreAdapter'],
};

export const ERGENECORE_CONTROLLER_IMPORTS: ImportsByFiles = {
  '@asenajs/asena/server': ['Controller'],
  '@asenajs/asena/web': ['Get'],
  '@asenajs/ergenecore': ['type Context'],
};

export const ERGENECORE_MIDDLEWARE_IMPORTS: ImportsByFiles = {
  '@asenajs/asena/server': ['Middleware'],
  '@asenajs/ergenecore': ['type Context', 'MiddlewareService'],
};

/**
 * Adapter package names for installation
 */
export const ADAPTER_PACKAGES: Record<'hono' | 'ergenecore', string> = {
  hono: '@asenajs/hono-adapter',
  ergenecore: '@asenajs/ergenecore',
};
```

**‚úÖ KONTROL EDƒ∞LDƒ∞:** Her iki adapter'ƒ±n export yapƒ±sƒ± doƒürulandƒ±.

---

### 4. Adapter Import Getter

**Dosya:** `lib/helpers/adapterImportHelper.ts` (YENƒ∞)

Adapter tipine g√∂re doƒüru importlarƒ± d√∂ner:

```typescript
import type { ImportsByFiles } from '../types';
import type { AdapterType } from '../types/adapterConfig';
import {
  HONO_ROOT_IMPORTS,
  HONO_CONTROLLER_IMPORTS,
  HONO_MIDDLEWARE_IMPORTS,
  ERGENECORE_ROOT_IMPORTS,
  ERGENECORE_CONTROLLER_IMPORTS,
  ERGENECORE_MIDDLEWARE_IMPORTS,
} from '../constants/adapters';

export function getRootImports(adapter: AdapterType): ImportsByFiles {
  return adapter === 'hono' ? HONO_ROOT_IMPORTS : ERGENECORE_ROOT_IMPORTS;
}

export function getControllerImports(adapter: AdapterType): ImportsByFiles {
  return adapter === 'hono' ? HONO_CONTROLLER_IMPORTS : ERGENECORE_CONTROLLER_IMPORTS;
}

export function getMiddlewareImports(adapter: AdapterType): ImportsByFiles {
  return adapter === 'hono' ? HONO_MIDDLEWARE_IMPORTS : ERGENECORE_MIDDLEWARE_IMPORTS;
}

export function getAdapterFunctionName(adapter: AdapterType): string {
  return adapter === 'hono' ? 'createHonoAdapter' : 'createErgenecoreAdapter';
}

export function getAdapterPackage(adapter: AdapterType): string {
  return adapter === 'hono' ? '@asenajs/hono-adapter' : '@asenajs/ergenecore';
}
```

---

### 5. Init Command G√ºncelleme

**Dosya:** `lib/commands/Init.ts` (G√úNCELLEME)

**Deƒüi≈üiklikler:**

1. Kullanƒ±cƒ±ya adapter se√ßimi sorulacak
2. `.asena/config.json` olu≈üturulacak
3. Mevcut `asena-config.ts` olu≈üturma korunacak

**G√ºncellenmi≈ü `exec()` metodu:**

```typescript
import inquirer from 'inquirer';
import { writeAdapterConfig } from '../helpers/adapterConfigHelper';
import type { AdapterType } from '../types/adapterConfig';

public async exec() {
  if (!isAsenaConfigExists()) {
    // 1. Adapter se√ßimi sor
    const { adapter } = await this.askAdapterQuestion();

    // 2. .asena/config.json olu≈ütur
    await writeAdapterConfig({ adapter });

    // 3. CLI paketini y√ºkle
    if (!(await getAsenaCliVersion())) {
      const asenaCliVersion = await $`asena --version`.quiet().text();
      await $`bun add -D @asenajs/asena-cli@${asenaCliVersion}`.quiet();
    }

    // 4. asena-config.ts olu≈ütur
    const numberOfBytes = await Bun.write('asena-config.ts', INITIAL_ASENA_CONFIG_TS);

    if (numberOfBytes === 0) {
      throw new Error('Failed to create asena config');
    }
  } else {
    console.log('\x1b[31m%s\x1b[0m', 'Config file already exists');
  }
}

private async askAdapterQuestion(): Promise<{ adapter: AdapterType }> {
  return inquirer.prompt([
    {
      type: 'list',
      name: 'adapter',
      message: 'Which adapter do you want to use?',
      choices: [
        { name: 'Hono Adapter (Recommended)', value: 'hono' },
        { name: 'Ergenecore Adapter', value: 'ergenecore' },
      ],
      default: 'hono',
    },
  ]);
}
```

---

### 6. Create Command G√ºncelleme

**Dosya:** `lib/commands/Create.ts` (G√úNCELLEME)

**Deƒüi≈üiklikler:**

1. Adapter se√ßimi sorulacak
2. Se√ßime g√∂re paket y√ºklenecek
3. Se√ßime g√∂re kod √ºretilecek
4. `.asena/config.json` olu≈üturulacak

**G√ºncellenmi≈ü metodlar:**

```typescript
import { writeAdapterConfig } from '../helpers/adapterConfigHelper';
import { getRootImports, getAdapterFunctionName, getAdapterPackage } from '../helpers/adapterImportHelper';
import type { AdapterType } from '../types/adapterConfig';

private preference: ProjectSetupOptions = {
  projectName: 'AsenaProject',
  adapter: 'hono',  // YENƒ∞ ALAN
  logger: true,
  eslint: true,
  prettier: true,
};

private async askQuestions(): Promise<ProjectSetupOptions> {
  const answers = await inquirer.prompt([
    {
      type: 'input',
      name: 'projectName',
      message: 'Enter your project name:',
      validate: (input: string) => (input ? true : 'Project name cannot be empty!'),
      default: 'AsenaProject',
    },
    {
      type: 'list',  // YENƒ∞ SORU
      name: 'adapter',
      message: 'Which adapter do you want to use?',
      choices: [
        { name: 'Hono Adapter (Recommended)', value: 'hono' },
        { name: 'Ergenecore Adapter', value: 'ergenecore' },
      ],
      default: 'hono',
    },
    {
      type: 'confirm',
      name: 'logger',
      message: 'Do you want to setup default asena logger?[Yes by default]',
      default: true,
    },
    {
      type: 'confirm',
      name: 'eslint',
      message: 'Do you want to setup ESLint?[Yes by default]',
      default: true,
    },
    {
      type: 'confirm',
      name: 'prettier',
      message: 'Do you want to setup Prettier?[Yes by default]',
      default: true,
    },
  ]);

  return {
    projectName: answers.projectName,
    adapter: answers.adapter,
    logger: answers.logger,
    eslint: answers.eslint,
    prettier: answers.prettier,
  };
}

private async create(currentFolder: boolean, spinner: Ora) {
  this.preference = await this.askQuestions();

  spinner.start();

  const projectPath = currentFolder ? process.cwd() : path.resolve(process.cwd(), this.preference.projectName);

  await this.createPackageJson(projectPath);
  await this.createDefaultController(projectPath);

  if (this.preference.logger) await this.createAsenaLogger(projectPath);

  await this.createDefaultIndexFile(projectPath);

  if (!currentFolder) process.chdir(projectPath);

  // .asena/config.json olu≈ütur (YENI)
  await writeAdapterConfig({ adapter: this.preference.adapter });

  await this.installPreRequests();

  if (this.preference.eslint) await this.installAndCreateEslint();
  if (this.preference.prettier) await this.installAndCreatePrettier();

  await this.createTsConfig();
  await new Init().exec();
}

private async createDefaultIndexFile(projectPath: string) {
  let rootFileCode = '';
  const adapter = this.preference.adapter;

  // Adapter'a g√∂re importlarƒ± al
  const rootFileImports = getRootImports(adapter);

  if (this.preference.logger) {
    rootFileImports['logger/logger'] = ['logger'];
  }

  rootFileCode = new ImportHandler(rootFileCode, ImportType.IMPORT)
    .importToCode(rootFileImports, ImportType.IMPORT);

  // √ñNEMLI: Adapter'larƒ±n farklƒ± signature'larƒ± var!
  // Hono: createHonoAdapter(logger) -> [adapter, logger]
  // Ergenecore: createErgenecoreAdapter({ logger }) -> adapter

  if (adapter === 'hono') {
    // Hono tuple d√∂nd√ºr√ºyor
    rootFileCode += `\nconst [honoAdapter, asenaLogger] = createHonoAdapter(${this.preference.logger ? 'logger' : 'console'});\n`;
    rootFileCode += new AsenaServerHandler('')
      .createEmptyAsenaServer('honoAdapter', 'asenaLogger').asenaServer;
  } else {
    // Ergenecore sadece adapter d√∂nd√ºr√ºyor
    const loggerArg = this.preference.logger ? 'logger' : 'console';
    rootFileCode += `\nconst ergenecoreAdapter = createErgenecoreAdapter({ logger: ${loggerArg} });\n`;
    rootFileCode += `const asenaLogger = ${loggerArg};\n`;
    rootFileCode += new AsenaServerHandler('')
      .createEmptyAsenaServer('ergenecoreAdapter', 'asenaLogger').asenaServer;
  }

  await Bun.write(projectPath + '/src/index.ts', rootFileCode);
}

private async installPreRequests() {
  const adapterPackage = getAdapterPackage(this.preference.adapter);

  await $`bun add @asenajs/asena ${adapterPackage}`.quiet();

  if (this.preference.logger) {
    await $`bun add @asenajs/asena-logger`.quiet();
  }

  await $`bun add -D @types/bun typescript`.quiet();
}
```

**Type g√ºncellemesi:**

```typescript
// lib/types/create.ts
import type { AdapterType } from './adapterConfig';

export interface ProjectSetupOptions {
  projectName: string;
  adapter: AdapterType;  // YENƒ∞
  logger: boolean;
  eslint: boolean;
  prettier: boolean;
}
```

---

### 7. Generate Command G√ºncelleme

**Dosya:** `lib/commands/Generate.ts` (G√úNCELLEME)

**Deƒüi≈üiklikler:**

1. `.asena/config.json` okunacak
2. Adapter'a g√∂re importlar kullanƒ±lacak

**G√ºncellenmi≈ü metodlar:**

```typescript
import { getAdapterConfig } from '../helpers/adapterConfigHelper';
import { getControllerImports, getMiddlewareImports } from '../helpers/adapterImportHelper';

private async generateController() {
  const controllerName = convertToPascalCase(removeExtension((await this.askQuestions('controller')).elementName));
  const importType = await getImportType();

  // Adapter config'i oku
  const adapter = await getAdapterConfig();

  const controllerCode =
    new ImportHandler('', importType).importToCode(
      { '@asenajs/asena/server': ['Controller'] },
      importType
    ) + new ControllerHandler('').addController(controllerName, null).code;

  await this.generate(controllerCode, 'controllers', controllerName);
}

private async addMiddleware() {
  const middlewareName = convertToPascalCase(removeExtension((await this.askQuestions('middleware')).elementName));
  const importType = await getImportType();

  // Adapter config'i oku
  const adapter = await getAdapterConfig();
  const middlewareImports = getMiddlewareImports(adapter);

  const middlewareCode =
    new ImportHandler('', importType).importToCode(middlewareImports, importType) +
    new MiddlewareHandler('').addMiddleware(middlewareName).addDefaultHandle(middlewareName).code;

  await this.generate(middlewareCode, 'middlewares', middlewareName);
}
```

---

### 8. Constants G√ºncellemesi

**Dosya:** `lib/constants/create.ts` (G√úNCELLEME)

Hono-specific constantlarƒ± kaldƒ±r, adapter helper'a ta≈üƒ±:

```typescript
// ESKƒ∞ - KALDIRILACAK
export const ROOT_FILE_IMPORTS: ImportsByFiles = {
  '@asenajs/asena': ['AsenaServerFactory'],
  '@asenajs/hono-adapter': ['createHonoAdapter'],
};

export const CONTROLLER_IMPORTS: ImportsByFiles = {
  '@asenajs/asena/server': ['Controller'],
  '@asenajs/asena/web': ['Get'],
  '@asenajs/hono-adapter': ['type Context'],
};

// YENƒ∞ - Bu constantlar lib/constants/adapters.ts'ye ta≈üƒ±nacak
```

---

## üß™ Test Senaryolarƒ±

### Test 1: Init with Hono (Default)
```bash
asena init
# Adapter se√ßimi: Hono
# .asena/config.json olu≈üturulmalƒ±: { "adapter": "hono" }
# asena-config.ts olu≈üturulmalƒ±
```

### Test 2: Init with Ergenecore
```bash
asena init
# Adapter se√ßimi: Ergenecore
# .asena/config.json olu≈üturulmalƒ±: { "adapter": "ergenecore" }
```

### Test 3: Create with Hono
```bash
asena create my-project
# Adapter se√ßimi: Hono
# @asenajs/hono-adapter y√ºklenmeli
# src/index.ts'de createHonoAdapter kullanƒ±lmalƒ±
# .asena/config.json olu≈üturulmalƒ±
```

### Test 4: Create with Ergenecore
```bash
asena create my-project
# Adapter se√ßimi: Ergenecore
# @asenajs/ergenecore y√ºklenmeli
# src/index.ts'de createErgenecoreAdapter kullanƒ±lmalƒ±
# .asena/config.json olu≈üturulmalƒ±
```

### Test 5: Generate Controller (Hono project)
```bash
cd hono-project
asena g c User
# Hono imports kullanƒ±lmalƒ±
# @asenajs/hono-adapter'dan Context import edilmeli
```

### Test 6: Generate Middleware (Ergenecore project)
```bash
cd ergenecore-project
asena g m Auth
# Ergenecore imports kullanƒ±lmalƒ±
# @asenajs/ergenecore'dan Context, MiddlewareService import edilmeli
```

---

## üìù Implementation Checklist

### Yeni Dosyalar
- [ ] `lib/types/adapterConfig.ts` - Type definitions
- [ ] `lib/helpers/adapterConfigHelper.ts` - Config read/write operations
- [ ] `lib/helpers/adapterImportHelper.ts` - Import getter functions
- [ ] `lib/constants/adapters.ts` - Adapter-specific imports

### G√ºncellenecek Dosyalar
- [ ] `lib/commands/Init.ts` - Adapter se√ßimi ekleme
- [ ] `lib/commands/Create.ts` - Adapter se√ßimi ve kullanƒ±mƒ±
- [ ] `lib/commands/Generate.ts` - Adapter'a g√∂re kod √ºretimi
- [ ] `lib/types/create.ts` - ProjectSetupOptions'a adapter alanƒ± ekleme
- [ ] `lib/constants/create.ts` - Hono-specific constantlarƒ± kaldƒ±rma

### Export G√ºncellemeleri
- [ ] `lib/types/index.ts` - AdapterConfig ve AdapterType export
- [ ] `lib/helpers/index.ts` - Yeni helper fonksiyonlarƒ±nƒ± export
- [ ] `lib/constants/index.ts` - Adapter constants export

---

## üéØ √ñnemli Notlar

### 1. Adapter Signature Farklarƒ± ‚ö†Ô∏è

**KRITIK:** ƒ∞ki adapter'ƒ±n factory fonksiyonlarƒ± farklƒ± signature'lara sahip!

**Hono Adapter:**
```typescript
// createHonoAdapter bir TUPLE d√∂nd√ºr√ºyor
export const createHonoAdapter = (logger?: ServerLogger): [HonoAdapter, ServerLogger]
// Kullanƒ±m:
const [honoAdapter, asenaLogger] = createHonoAdapter(logger);
```

**Ergenecore Adapter:**
```typescript
// createErgenecoreAdapter sadece adapter instance d√∂nd√ºr√ºyor
export function createErgenecoreAdapter(options: ErgenecoreOptions): Ergenecore
// Kullanƒ±m:
const ergenecoreAdapter = createErgenecoreAdapter({ logger });
const asenaLogger = logger; // Logger'ƒ± ayrƒ±ca tutmalƒ±yƒ±z
```

Bu fark, kod √ºretiminde dikkate alƒ±nmalƒ±! (Bkz: Section 6 - createDefaultIndexFile)

### 2. Doƒürulanmƒ±≈ü Export Yapƒ±larƒ± ‚úÖ

**Hono Adapter Exports:**
```typescript
import { createHonoAdapter } from '@asenajs/hono-adapter';
import { type Context, MiddlewareService } from '@asenajs/hono-adapter';
```

**Ergenecore Adapter Exports:**
```typescript
import { createErgenecoreAdapter } from '@asenajs/ergenecore';
import { type Context, MiddlewareService } from '@asenajs/ergenecore';
```

**‚úÖ VERIFIED:** Her iki adapter'ƒ±n export yapƒ±sƒ± kontrol edildi ve doƒürulandƒ±.

### 3. Backward Compatibility
Mevcut projelerde `.asena/config.json` yoksa:
- Default olarak `hono` adapter varsayƒ±lmalƒ±
- Kullanƒ±cƒ±ya uyarƒ± g√∂sterilmeli: "No adapter config found, using 'hono' by default"

### 4. Error Handling
- `.asena/config.json` corrupt ise ‚Üí Default'a d√º≈ü
- Bilinmeyen adapter tipi varsa ‚Üí Error at ve desteklenen adapter'larƒ± listele

### 5. Migration Guide
Mevcut Hono kullanan projelere `.asena/config.json` ekleme:
```bash
mkdir -p .asena
echo '{"adapter":"hono"}' > .asena/config.json
```

---

## üöÄ ƒ∞mplementasyon Sƒ±rasƒ±

1. **Type Definitions** ‚Üí √ñnce type'larƒ± olu≈ütur
2. **Config Helpers** ‚Üí Config okuma/yazma fonksiyonlarƒ±
3. **Adapter Constants** ‚Üí Import definitionlarƒ±
4. **Import Helpers** ‚Üí Getter fonksiyonlar
5. **Init Command** ‚Üí Adapter se√ßimi ekleme
6. **Create Command** ‚Üí Full adapter support
7. **Generate Command** ‚Üí Adapter'a g√∂re kod √ºretimi
8. **Testing** ‚Üí T√ºm senaryolarƒ± test et

---

## üìö Referanslar

- Bun File API: https://bun.sh/docs/api/file-io
- Bun JSON: https://bun.sh/docs/api/file-io#reading-files-bun-file
- Inquirer: https://github.com/SBoudrias/Inquirer.js

---

**Son G√ºncelleme:** 2025-10-14
**Yakla≈üƒ±m:** Minimal JSON Config (A)
**Status:** Ready for Implementation
